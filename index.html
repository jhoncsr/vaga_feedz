<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vagas - TOTVS/Credi Shop</title>
    <style>
        :root {
            --primary: #FF5A00;
            --secondary: #2c3e50;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #333;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--secondary); margin-bottom: 10px; }
        p { color: #666; }
        
        .control-panel { background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; margin-bottom: 20px; }
        
        button { background-color: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; }
        button:hover { background-color: #e04f00; transform: translateY(-2px); }
        
        input[type="file"] { display: none; }
        .file-label { background-color: var(--secondary); color: white; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; display: inline-block; }
        .file-label:hover { background-color: #34495e; }

        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .filter-select { padding: 12px; border: 1px solid #ddd; border-radius: 5px; min-width: 150px; }

        .summary-bar { display: flex; justify-content: space-between; background: #e0e0e0; padding: 10px 20px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; color: var(--secondary); flex-wrap: wrap; gap: 10px; }

        .jobs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .job-card { background: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; display: flex; flex-direction: column; border-left: 5px solid var(--primary); }
        .job-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .job-title { font-size: 1.2rem; font-weight: bold; color: var(--secondary); margin-bottom: 5px; }
        .job-company { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 15px; font-weight: 600; text-transform: uppercase; }
        
        .job-details { display: flex; gap: 10px; margin-bottom: 15px; font-size: 0.85rem; color: #555; flex-wrap: wrap; }
        .tag { background: #eee; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 5px; }
        
        .job-description { font-size: 0.9rem; color: #666; margin-bottom: 20px; flex-grow: 1; max-height: 100px; overflow: hidden; position: relative; }
        .job-description::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; background: linear-gradient(to bottom, transparent, white); }

        .job-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 15px; }
        .salary { font-weight: bold; color: #27ae60; font-size: 1.1rem; }
        
        .btn-apply { text-decoration: none; background-color: var(--secondary); color: white; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; text-align: center; }
        .btn-apply:hover { background-color: var(--primary); }

        .hidden { display: none !important; }
        .loading { text-align: center; font-size: 1.2rem; color: #666; margin: 40px; font-weight: bold; }
        
        .cors-warning { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; text-align: center;}
        .cors-warning a { color: #856404; font-weight: bold; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üéØ Painel de Vagas</h1>
        <p>TOTVS / Credi Shop</p>
    </header>

    <div id="corsMsg" class="cors-warning"></div>

    <div class="control-panel">
        <button onclick="fetchWithProxy()">üîÑ Atualizar Vagas</button>
        
        <span style="color: #ccc;">|</span>
        
        <label for="fileInput" class="file-label">üìÇ Abrir XML (Backup)</label>
        <input type="file" id="fileInput" accept=".xml">
    </div>

    <div class="filters">
        <input type="text" id="searchInput" class="search-box" placeholder="üîé Buscar por cargo, cidade ou descri√ß√£o...">
        <select id="stateFilter" class="filter-select">
            <option value="">Todos os Estados</option>
        </select>
        <select id="cityFilter" class="filter-select">
            <option value="">Todas as Cidades</option>
        </select>
    </div>

    <div class="summary-bar">
        <span id="totalCount">Vagas encontradas: 0</span>
        <span id="lastUpdate">Aguardando dados...</span>
    </div>

    <div id="loading" class="loading hidden">üöÄ Conectando ao servidor...</div>
    <div id="jobsContainer" class="jobs-grid"></div>
</div>

<script>
    // URL da TOTVS fornecida
    const TARGET_URL = 'https://api-centraldocandidato.totvs.app/applicant/static-files/get-xml';
    
    // CONFIGURA√á√ÉO DO PROXY
    // Trocamos para o corsproxy.io que costuma ser mais permissivo com headers
    // Formato: https://corsproxy.io/?URL_ENCODED
    const PROXY_BASE = 'https://corsproxy.io/?';

    let allJobs = [];

    // Tenta carregar automaticamente ao abrir
    window.addEventListener('DOMContentLoaded', () => {
        fetchWithProxy();
    });

    function fetchWithProxy() {
        showLoading(true, "üöÄ Buscando vagas (Via Proxy)...");
        document.getElementById('corsMsg').style.display = 'none';
        
        // Adiciona timestamp para evitar cache do proxy e do navegador
        const noCacheParam = '&timestamp=' + new Date().getTime();
        
        // Monta a URL final passando pelo proxy
        const finalUrl = PROXY_BASE + encodeURIComponent(TARGET_URL + '?v=' + new Date().getTime());

        console.log("Tentando acessar:", finalUrl);

        fetch(finalUrl, {
            method: 'GET',
            cache: 'no-store' // For√ßa o navegador a n√£o usar cache local
        })
            .then(response => {
                if (!response.ok) throw new Error(`Servidor respondeu com erro: ${response.status}`);
                return response.text();
            })
            .then(xmlString => {
                // Valida√ß√£o b√°sica se veio algo que parece XML
                if (!xmlString || !xmlString.trim().startsWith('<')) {
                    throw new Error("A resposta n√£o parece ser um XML v√°lido.");
                }
                parseXML(xmlString);
            })
            .catch(err => {
                console.error("Erro no fetch:", err);
                showLoading(false);
                const msg = document.getElementById('corsMsg');
                msg.innerHTML = `
                    <strong>‚ö†Ô∏è N√£o foi poss√≠vel carregar as vagas automaticamente.</strong><br>
                    Motivo: ${err.message}<br><br>
                    Isso geralmente ocorre por bloqueio de seguran√ßa da rede da empresa.<br>
                    <a href="${TARGET_URL}" target="_blank">Clique aqui para baixar o XML manualmente</a> e depois use o bot√£o "Abrir XML" acima.
                `;
                msg.style.display = 'block';
            });
    }

    // Leitura Manual de Arquivo (Plano B)
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        showLoading(true, "Lendo arquivo local...");
        const reader = new FileReader();
        reader.onload = function(e) {
            parseXML(e.target.result);
        };
        reader.onerror = function() {
            alert("Erro ao ler o arquivo.");
            showLoading(false);
        };
        reader.readAsText(file);
    });

    function parseXML(xmlString) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            
            // Verifica se o parser do navegador falhou
            const parserError = xmlDoc.getElementsByTagName("parsererror");
            if (parserError.length > 0) {
                throw new Error("XML mal formatado ou corrompido.");
            }

            // Tenta pegar a data de atualiza√ß√£o
            const lastBuild = xmlDoc.querySelector('lastBuildDate')?.textContent 
                           || xmlDoc.querySelector('pubDate')?.textContent 
                           || new Date().toISOString();
            
            try {
                const dateObj = new Date(lastBuild);
                document.getElementById('lastUpdate').innerText = `Atualizado em: ${dateObj.toLocaleDateString('pt-BR')} √†s ${dateObj.toLocaleTimeString('pt-BR')}`;
            } catch(e) { 
                document.getElementById('lastUpdate').innerText = `Atualiza√ß√£o: Recente`; 
            }

            // Ler Vagas
            const jobs = xmlDoc.getElementsByTagName('job');
            allJobs = [];

            if (jobs.length === 0) {
                // Tenta procurar 'item' caso o RSS seja padr√£o
                const items = xmlDoc.getElementsByTagName('item');
                if(items.length > 0) alert("Formato de XML diferente detectado (RSS padr√£o). O c√≥digo precisa de ajuste para tags <item>.");
            }

            for (let i = 0; i < jobs.length; i++) {
                const job = jobs[i];
                
                // Fun√ß√£o auxiliar segura para pegar texto de tags
                const getVal = (tag) => {
                    const el = job.getElementsByTagName(tag)[0];
                    return el ? el.textContent.trim() : 'N/A';
                };

                // Tratamento especial para sal√°rio
                let salaryDisplay = 'A combinar';
                const salaryEl = job.getElementsByTagName('salary')[0];
                if (salaryEl) {
                    const lowEl = salaryEl.getElementsByTagName('lowEnd')[0]?.getElementsByTagName('amount')[0];
                    const highEl = salaryEl.getElementsByTagName('highEnd')[0]?.getElementsByTagName('amount')[0];
                    
                    if (lowEl) {
                        const valLow = parseFloat(lowEl.textContent);
                        const valHigh = highEl ? parseFloat(highEl.textContent) : valLow;

                        if (!isNaN(valLow)) {
                            const fmt = (v) => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                            salaryDisplay = (valLow === valHigh) ? fmt(valLow) : `${fmt(valLow)} - ${fmt(valHigh)}`;
                        }
                    }
                }

                allJobs.push({
                    id: getVal('partnerJobId'),
                    company: getVal('company'),
                    title: getVal('title'),
                    description: getVal('description'), 
                    city: getVal('city'),
                    state: getVal('state'),
                    applyUrl: getVal('applyUrl'),
                    salary: salaryDisplay,
                    type: getVal('workplaceTypes') !== 'N/A' ? getVal('workplaceTypes') : 'Presencial/Remoto'
                });
            }

            populateFilters();
            renderJobs(allJobs);
            showLoading(false);

        } catch (e) {
            console.error(e);
            showLoading(false);
            const msg = document.getElementById('corsMsg');
            msg.innerHTML = `<strong>Erro ao processar dados:</strong> O arquivo foi baixado, mas h√° um erro de leitura.<br>Detalhe: ${e.message}`;
            msg.style.display = 'block';
        }
    }

    function renderJobs(jobsList) {
        const container = document.getElementById('jobsContainer');
        const countSpan = document.getElementById('totalCount');
        container.innerHTML = '';
        countSpan.innerText = `Vagas listadas: ${jobsList.length}`;

        if(jobsList.length === 0) {
            container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; font-size: 1.2rem; color: #777; margin-top: 20px;">Nenhuma vaga encontrada.</p>';
            return;
        }

        jobsList.forEach(job => {
            const card = document.createElement('div');
            card.className = 'job-card';
            
            // Limpa HTML da descri√ß√£o para o resumo
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = job.description;
            let plainText = tempDiv.textContent || tempDiv.innerText || "";
            plainText = plainText.replace(/N\/A/g, ''); // Remove N/A se aparecer
            const shortDesc = plainText.length > 140 ? plainText.substring(0, 140) + "..." : plainText;

            // Link do bot√£o
            const linkApply = job.applyUrl !== 'N/A' ? job.applyUrl : '#';

            card.innerHTML = `
                <div class="job-title">${job.title}</div>
                <div class="job-company">${job.company}</div>
                
                <div class="job-details">
                    <span class="tag">üìç ${job.city} - ${job.state}</span>
                    <span class="tag">üè¢ ${job.type}</span>
                </div>

                <div class="job-description" title="Descri√ß√£o completa no site da vaga">
                    ${shortDesc}
                </div>

                <div class="job-footer">
                    <div class="salary">${job.salary}</div>
                    <a href="${linkApply}" target="_blank" class="btn-apply">Ver Vaga ‚ûî</a>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function populateFilters() {
        const states = [...new Set(allJobs.map(j => j.state).filter(s => s !== 'N/A'))].sort();
        const cities = [...new Set(allJobs.map(j => j.city).filter(c => c !== 'N/A'))].sort();

        const stateSelect = document.getElementById('stateFilter');
        const citySelect = document.getElementById('cityFilter');

        stateSelect.innerHTML = '<option value="">Todos os Estados</option>';
        citySelect.innerHTML = '<option value="">Todas as Cidades</option>';

        states.forEach(st => {
            const opt = document.createElement('option');
            opt.value = st;
            opt.innerText = st;
            stateSelect.appendChild(opt);
        });

        cities.forEach(ct => {
            const opt = document.createElement('option');
            opt.value = ct;
            opt.innerText = ct;
            citySelect.appendChild(opt);
        });
    }

    function filterData() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const state = document.getElementById('stateFilter').value;
        const city = document.getElementById('cityFilter').value;

        const filtered = allJobs.filter(job => {
            const matchText = job.title.toLowerCase().includes(term) || 
                              job.description.toLowerCase().includes(term) ||
                              job.company.toLowerCase().includes(term);
            const matchState = state ? job.state === state : true;
            const matchCity = city ? job.city === city : true;

            return matchText && matchState && matchCity;
        });

        renderJobs(filtered);
    }

    document.getElementById('searchInput').addEventListener('input', filterData);
    document.getElementById('stateFilter').addEventListener('change', filterData);
    document.getElementById('cityFilter').addEventListener('change', filterData);

    function showLoading(show, text = "Carregando...") {
        const el = document.getElementById('loading');
        el.innerText = text;
        if(show) {
            el.classList.remove('hidden');
            document.getElementById('jobsContainer').innerHTML = '';
        } else {
            el.classList.add('hidden');
        }
    }
</script>

</body>
</html>