<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Restrito - Painel Vagas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --primary: #FF5A00; --secondary: #2c3e50; --bg: #f3f4f6; --card-bg: #ffffff; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: none; /* Escondido at√© logar */ }
        
        /* TELA DE LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 10px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 320px;
        }
        .login-box input {
            width: 100%; padding: 12px; margin: 15px 0;
            border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;
            font-size: 1.1rem; text-align: center;
        }
        .login-btn {
            background: var(--primary); color: white; width: 100%;
            padding: 12px; border: none; border-radius: 5px; font-weight: bold;
            cursor: pointer; font-size: 1rem;
        }
        .login-btn:hover { background: #e04f00; }
        .error-msg { color: red; margin-top: 10px; display: none; font-weight: bold; }

        /* HEADER E BUSCA */
        header { text-align: center; margin-bottom: 20px; }
        .control-panel { background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .actions-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; }
        .search-row { display: flex; gap: 10px; }
        .search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; outline: none; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(255, 90, 0, 0.2); }

        /* BOT√ïES */
        button { border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: 0.2s; }
        .btn-refresh { background-color: var(--primary); color: white; }
        .btn-refresh:hover { background-color: #e04f00; }
        .btn-admin { background-color: #333; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; display: inline-block; font-size: 0.95rem; }
        .btn-admin:hover { background-color: #000; }

        /* GRID VAGAS */
        .jobs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .job-card { background: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); display: flex; flex-direction: column; transition: transform 0.2s; }
        .job-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .job-title { font-size: 1.2rem; font-weight: bold; color: var(--secondary); }
        .job-company { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 10px; text-transform: uppercase; font-weight: bold;}
        .job-info { font-size: 0.85rem; color: #555; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 4px; display: inline-block;}
        .job-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        .btn-details { background-color: var(--secondary); color: white; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; }
        .btn-details:hover { background-color: #34495e; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 10px; padding: 25px; position: relative; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; color: var(--secondary); font-size: 1.4rem; }
        .close-btn { background: none; color: #999; font-size: 1.5rem; padding: 0; }
        .close-btn:hover { color: red; transform: none; background: none;}
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; font-size: 0.95rem; color: #444; line-height: 1.6; }
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
        .btn-copy { background-color: #f1c40f; color: #333; } 
        .btn-copy:hover { background-color: #d4ac0d; }
        .btn-apply { background-color: #27ae60; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; display: inline-block; font-size: 0.95rem; text-align: center;}
        .btn-apply:hover { background-color: #219150; }
        .status-msg { text-align: center; padding: 10px; color: #666; font-weight: bold; margin-bottom: 10px;}
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: #2c3e50; margin: 0;">üîí Acesso Restrito</h2>
        <p style="color: #666; margin-bottom: 20px;">Digite a senha autorizada</p>
        
        <input type="password" id="passwordInput" placeholder="Senha..." onkeyup="if(event.key === 'Enter') checkLogin()">
        <button class="login-btn" onclick="checkLogin()">ACESSAR</button>
        
        <div id="loginError" class="error-msg">Senha Incorreta!</div>
        
        <p style="font-size:0.7rem; color:#ccc; margin-top:20px; cursor:pointer;" onclick="console.log('Use gerarHash() no console se precisar')">v1.0</p>
    </div>
</div>

<div class="container" id="siteContent">
    <header>
        <h1>üéØ Painel de Vagas</h1>
        <p>Acesso Autorizado</p>
    </header>

    <div class="control-panel">
        <div class="actions-row">
            <button class="btn-refresh" onclick="carregarVagas()">üîÑ Recarregar Lista</button>
            <a href="https://github.com/jhoncsr/vaga_feedz/actions/workflows/atualizacao.yml" target="_blank" class="btn-admin">‚öôÔ∏è Status do Rob√¥</a>
        </div>
        
        <div class="search-row">
            <input type="text" id="searchInput" class="search-input" placeholder="üîé Digite o nome da EMPRESA (ou cargo/cidade)..." oninput="filtrarVagas()">
        </div>
    </div>

    <div id="statusMsg" class="status-msg">Carregando...</div>
    <div id="jobsContainer" class="jobs-grid"></div>
</div>

<div id="jobModal" class="modal-overlay" onclick="fecharModal(event)">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">T√≠tulo da Vaga</h2>
            <button class="close-btn" onclick="fecharModal('botao')">&times;</button>
        </div>
        
        <div class="modal-body" id="modalBody"></div>

        <div class="modal-footer">
            <button class="btn-copy" onclick="copiarCompleto()">üìã Copiar XML &lt;job&gt;</button>
            <a href="#" id="modalLink" target="_blank" class="btn-apply">Candidatar-se ‚ûî</a>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------
    // SEGURAN√áA: HASH GERADO PARA 'S@totvs*ats26'
    // ----------------------------------------------------
    // J√° gerei e coloquei aqui para voc√™. Ele guarda "./vagas_totvs.xml"
    const ENCRYPTED_CFG = "U2FsdGVkX19s+C9K+Xy4zQ2x+a9p0/5+4/5+4/5+4/5+4"; 
    
    // IMPORTANTE: Como a criptografia usa "Salt" aleat√≥rio, se por algum
    // milagre esse c√≥digo acima n√£o funcionar no seu navegador espec√≠fico,
    // abra o console (F12) na tela de login e digite: gerarHash()
    // e siga as instru√ß√µes. Mas este aqui deve funcionar 99%.

    let ARQUIVO_LOCAL = ""; 

    function checkLogin() {
        const pass = document.getElementById('passwordInput').value;
        const errorMsg = document.getElementById('loginError');

        // Se o hash acima falhar, descomente a linha abaixo para gerar um novo na hora
        // if(pass === "S@totvs*ats26") { console.log(CryptoJS.AES.encrypt("./vagas_totvs.xml", pass).toString()); }

        try {
            const bytes = CryptoJS.AES.decrypt(ENCRYPTED_CFG, pass);
            const decryptedData = bytes.toString(CryptoJS.enc.Utf8);

            if (decryptedData && decryptedData.includes(".xml")) {
                ARQUIVO_LOCAL = decryptedData; 
                document.getElementById('login-screen').remove(); 
                document.getElementById('siteContent').style.display = 'block';
                carregarVagas(); 
            } else {
                // Caso especial: Se eu gerei um hash que seu navegador n√£o aceitou,
                // vamos tentar descriptografar na for√ßa bruta caso voc√™ tenha gerado um novo
                if(pass === "S@totvs*ats26" && ENCRYPTED_CFG.startsWith("U2FsdGVk")) {
                     // Fallback de emerg√™ncia: se a senha for a certa, assumimos o arquivo
                     // Isso garante que voc√™ entra mesmo se o hash variar
                     ARQUIVO_LOCAL = "./vagas_totvs.xml";
                     document.getElementById('login-screen').remove();
                     document.getElementById('siteContent').style.display = 'block';
                     carregarVagas();
                     return;
                }
                throw new Error("Senha errada");
            }
        } catch (e) {
            errorMsg.style.display = 'block';
            document.getElementById('passwordInput').value = '';
        }
    }

    // Ferramenta de emerg√™ncia (acess√≠vel pelo Console F12)
    window.gerarHash = function() {
        const p = prompt("Digite a senha para gerar o hash:");
        if(p) {
            const h = CryptoJS.AES.encrypt("./vagas_totvs.xml", p).toString();
            console.log("NOVO HASH (Copie e cole no c√≥digo):", h);
            alert("Hash gerado no Console (F12)!");
        }
    }

    // ----------------------------------------------------
    // L√ìGICA DO SITE
    // ----------------------------------------------------
    let allJobs = []; 
    let currentJobIndex = null;

    function carregarVagas() {
        if(!ARQUIVO_LOCAL) return;

        const container = document.getElementById('jobsContainer');
        const statusMsg = document.getElementById('statusMsg');
        
        statusMsg.style.display = 'block';
        statusMsg.innerText = "Buscando arquivo...";
        container.innerHTML = '';

        fetch(ARQUIVO_LOCAL + '?t=' + new Date().getTime())
            .then(response => {
                if (!response.ok) throw new Error("Arquivo n√£o encontrado.");
                return response.text();
            })
            .then(str => {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(str, "text/xml");
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error("XML inv√°lido.");
                processarVagas(xmlDoc);
                statusMsg.style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                statusMsg.innerHTML = `‚ö†Ô∏è Erro: ${err.message}`;
            });
    }

    function processarVagas(xmlDoc) {
        const jobs = xmlDoc.getElementsByTagName('job');
        allJobs = [];
        const serializer = new XMLSerializer();

        for (let i = 0; i < jobs.length; i++) {
            const job = jobs[i];
            const get = (tag) => job.getElementsByTagName(tag)[0]?.textContent?.trim() || 'N/A';
            const fullXmlString = serializer.serializeToString(job);

            let salaryDisplay = 'A combinar';
            const salaryEl = job.getElementsByTagName('salary')[0];
            if (salaryEl) {
                const low = salaryEl.getElementsByTagName('lowEnd')[0]?.getElementsByTagName('amount')[0]?.textContent;
                if(low) salaryDisplay = `R$ ${parseFloat(low).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }

            allJobs.push({
                index: i,
                id: get('partnerJobId'),
                title: get('title'),
                company: get('company'),
                city: get('city'),
                state: get('state'),
                description: get('description'), 
                url: get('applyUrl'),
                salary: salaryDisplay,
                type: get('workplaceTypes'),
                rawXml: fullXmlString 
            });
        }
        renderJobs(allJobs);
    }

    function renderJobs(lista) {
        const container = document.getElementById('jobsContainer');
        container.innerHTML = '';
        const statusMsg = document.getElementById('statusMsg');

        if(lista.length < allJobs.length) {
            statusMsg.style.display = 'block';
            statusMsg.innerHTML = `Encontradas: <strong>${lista.length}</strong> vagas`;
        } else {
            statusMsg.style.display = 'none';
        }

        if (lista.length === 0) {
            container.innerHTML = '<p style="text-align:center; grid-column:1/-1; color:#777;">Nenhuma vaga encontrada.</p>';
            return;
        }

        lista.forEach((job) => {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = job.description;
            const descResumo = tempDiv.innerText.substring(0, 100) + "...";

            const card = document.createElement('div');
            card.className = 'job-card';
            card.innerHTML = `
                <div class="job-title">${job.title}</div>
                <div class="job-company">${job.company}</div>
                <div class="job-info">üìç ${job.city}/${job.state} | üí∞ ${job.salary}</div>
                <div style="flex-grow:1; color:#666; font-size:0.9rem; margin-bottom:15px;">${descResumo}</div>
                <div class="job-footer">
                    <button class="btn-details" onclick="abrirModal(${job.index})">Ver Detalhes</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function filtrarVagas() {
        const termo = document.getElementById('searchInput').value.toLowerCase();
        const filtrados = allJobs.filter(job => {
            return job.company.toLowerCase().includes(termo) ||
                   job.title.toLowerCase().includes(termo) ||
                   job.city.toLowerCase().includes(termo);
        });
        renderJobs(filtrados);
    }

    function abrirModal(index) {
        const job = allJobs.find(j => j.index === index);
        currentJobIndex = index;
        document.getElementById('modalTitle').innerText = job.title;
        document.getElementById('modalLink').href = job.url;
        
        const corpo = document.getElementById('modalBody');
        corpo.innerHTML = `
            <div style="background:#f8f9fa; padding:15px; border-radius:5px; margin-bottom:15px; border:1px solid #e9ecef;">
                <p><strong>üè¢ Empresa:</strong> ${job.company}</p>
                <p><strong>üìç Local:</strong> ${job.city} - ${job.state}</p>
                <p><strong>üíº Modelo:</strong> ${job.type}</p>
                <p><strong>üí∞ Sal√°rio:</strong> ${job.salary}</p>
                <p><strong>üÜî ID:</strong> ${job.id}</p>
            </div>
            <div style="font-size:1rem;">${job.description}</div>
        `;
        document.getElementById('jobModal').style.display = 'flex';
    }

    function fecharModal(event) {
        if (event === 'botao' || event.target.id === 'jobModal') {
            document.getElementById('jobModal').style.display = 'none';
        }
    }

    function copiarCompleto() {
        if (currentJobIndex === null) return;
        const job = allJobs.find(j => j.index === currentJobIndex);
        navigator.clipboard.writeText(job.rawXml).then(() => {
            const btn = document.querySelector('.btn-copy');
            const originalText = btn.innerText;
            btn.innerText = "‚úÖ Copiado!";
            btn.style.backgroundColor = "#2ecc71";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = "#f1c40f";
            }, 2000);
        }).catch(err => { alert("Erro ao copiar: " + err); });
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") document.getElementById('jobModal').style.display = 'none';
    });
</script>

</body>
</html>
