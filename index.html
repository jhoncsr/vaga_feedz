<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vagas - TOTVS/Credi Shop</title>
    <style>
        :root {
            --primary: #FF5A00;
            --secondary: #2c3e50;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #333;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--secondary); margin-bottom: 10px; }
        
        .control-panel { background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; margin-bottom: 20px; }
        
        button { background-color: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; }
        button:hover { background-color: #e04f00; transform: translateY(-2px); }
        
        input[type="file"] { display: none; }
        .file-label { background-color: var(--secondary); color: white; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .file-label:hover { background-color: #34495e; }

        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .filter-select { padding: 12px; border: 1px solid #ddd; border-radius: 5px; min-width: 150px; }

        .summary-bar { display: flex; justify-content: space-between; background: #e0e0e0; padding: 10px 20px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; color: var(--secondary); }

        .jobs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .job-card { background: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; display: flex; flex-direction: column; border-left: 5px solid var(--primary); }
        .job-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .job-title { font-size: 1.2rem; font-weight: bold; color: var(--secondary); margin-bottom: 5px; }
        .job-company { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 15px; font-weight: 600; text-transform: uppercase; }
        
        .job-details { display: flex; gap: 10px; margin-bottom: 15px; font-size: 0.85rem; color: #555; }
        .tag { background: #eee; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 5px; }
        
        .job-description { font-size: 0.9rem; color: #666; margin-bottom: 20px; flex-grow: 1; max-height: 100px; overflow: hidden; position: relative; }
        .job-description::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; background: linear-gradient(to bottom, transparent, white); }

        .job-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 15px; }
        .salary { font-weight: bold; color: #27ae60; font-size: 1.1rem; }
        
        .btn-apply { text-decoration: none; background-color: var(--secondary); color: white; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; }
        .btn-apply:hover { background-color: var(--primary); }

        .hidden { display: none; }
        .loading { text-align: center; font-size: 1.2rem; color: #666; margin: 40px; font-weight: bold; }
        
        .cors-warning { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; text-align: center;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üéØ Painel de Vagas TOTVS</h1>
        <p>Dados obtidos via API (Bypass CORS)</p>
    </header>

    <div id="corsMsg" class="cors-warning"></div>

    <div class="control-panel">
        <button onclick="fetchWithProxy()">üîÑ Carregar Vagas (Autom√°tico)</button>
        
        <span style="color: #999;">|</span>
        
        <label for="fileInput" class="file-label">üìÇ Carregar Arquivo Manualmente</label>
        <input type="file" id="fileInput" accept=".xml">
    </div>

    <div class="filters">
        <input type="text" id="searchInput" class="search-box" placeholder="üîé Buscar por cargo, cidade ou descri√ß√£o...">
        <select id="stateFilter" class="filter-select">
            <option value="">Todos os Estados</option>
        </select>
        <select id="cityFilter" class="filter-select">
            <option value="">Todas as Cidades</option>
        </select>
    </div>

    <div class="summary-bar">
        <span id="totalCount">Vagas encontradas: 0</span>
        <span id="lastUpdate">Aguardando carregamento...</span>
    </div>

    <div id="loading" class="loading hidden">üöÄ Conectando ao servidor via Proxy...</div>
    <div id="jobsContainer" class="jobs-grid"></div>
</div>

<script>
    // URL original da TOTVS
    const TARGET_URL = 'https://api-centraldocandidato.totvs.app/applicant/static-files/get-xml';
    
    // Usamos um Proxy p√∫blico (AllOrigins) para evitar o bloqueio do navegador
    // Isso faz o navegador pensar que estamos acessando um site seguro que permite o acesso
    const PROXY_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(TARGET_URL);

    let allJobs = [];

    // Fun√ß√£o Principal: Busca usando o Proxy
    function fetchWithProxy() {
        showLoading(true, "üöÄ Buscando dados...");
        document.getElementById('corsMsg').style.display = 'none';
        
        // Adiciona um timestamp para evitar cache do navegador
        const finalUrl = PROXY_URL + '&timestamp=' + new Date().getTime();

        fetch(finalUrl)
            .then(response => {
                if (!response.ok) throw new Error("Falha ao acessar o proxy.");
                return response.text();
            })
            .then(xmlString => {
                if (!xmlString || xmlString.length < 50) throw new Error("XML vazio ou inv√°lido.");
                parseXML(xmlString);
            })
            .catch(err => {
                console.error(err);
                showLoading(false);
                const msg = document.getElementById('corsMsg');
                msg.innerHTML = `<strong>Erro de Conex√£o:</strong> N√£o foi poss√≠vel carregar automaticamente.<br>Tente novamente ou baixe o arquivo XML manualmente.`;
                msg.style.display = 'block';
            });
    }

    // Carregamento Manual (Backup)
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        showLoading(true, "Lendo arquivo...");
        const reader = new FileReader();
        reader.onload = function(e) {
            parseXML(e.target.result);
        };
        reader.readAsText(file);
    });

    // Processar o XML
    function parseXML(xmlString) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            
            // Verifica erro de parse
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                throw new Error("Erro ao interpretar o XML.");
            }

            // Metadados
            const lastBuild = xmlDoc.querySelector('lastBuildDate')?.textContent || '-';
            try {
                document.getElementById('lastUpdate').innerText = `Atualiza√ß√£o: ${new Date(lastBuild).toLocaleString('pt-BR')}`;
            } catch(e) { 
                document.getElementById('lastUpdate').innerText = `Atualiza√ß√£o: ${lastBuild}`; 
            }

            // Ler Vagas
            const jobs = xmlDoc.getElementsByTagName('job');
            allJobs = [];

            for (let i = 0; i < jobs.length; i++) {
                const job = jobs[i];
                
                const getVal = (tag) => {
                    const el = job.getElementsByTagName(tag)[0];
                    return el ? el.textContent.trim() : '';
                };

                // Formata√ß√£o de Sal√°rio
                let salaryDisplay = 'A combinar';
                const salaryEl = job.getElementsByTagName('salary')[0];
                if (salaryEl) {
                    const lowEl = salaryEl.getElementsByTagName('lowEnd')[0]?.getElementsByTagName('amount')[0];
                    const highEl = salaryEl.getElementsByTagName('highEnd')[0]?.getElementsByTagName('amount')[0];
                    
                    if (lowEl && highEl) {
                        const valLow = parseFloat(lowEl.textContent);
                        const valHigh = parseFloat(highEl.textContent);

                        if (!isNaN(valLow) && !isNaN(valHigh)) {
                            if (valLow === valHigh) {
                                salaryDisplay = valLow.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                            } else {
                                salaryDisplay = `${valLow.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} - ${valHigh.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
                            }
                        }
                    }
                }

                allJobs.push({
                    id: getVal('partnerJobId'),
                    company: getVal('company'),
                    title: getVal('title'),
                    description: getVal('description'), 
                    city: getVal('city'),
                    state: getVal('state'),
                    applyUrl: getVal('applyUrl'),
                    salary: salaryDisplay,
                    type: getVal('workplaceTypes')
                });
            }

            populateFilters();
            renderJobs(allJobs);
            showLoading(false);
            document.getElementById('corsMsg').style.display = 'none';

        } catch (e) {
            alert("Erro ao processar os dados: " + e.message);
            console.error(e);
            showLoading(false);
        }
    }

    // Renderizar na Tela
    function renderJobs(jobsList) {
        const container = document.getElementById('jobsContainer');
        const countSpan = document.getElementById('totalCount');
        container.innerHTML = '';
        countSpan.innerText = `Vagas listadas: ${jobsList.length}`;

        if(jobsList.length === 0) {
            container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; font-size: 1.2rem; color: #777;">Nenhuma vaga encontrada com os filtros atuais.</p>';
            return;
        }

        jobsList.forEach(job => {
            const card = document.createElement('div');
            card.className = 'job-card';
            
            // Remove tags HTML da descri√ß√£o para o preview
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = job.description;
            const plainText = tempDiv.textContent || tempDiv.innerText || "";
            const shortDesc = plainText.length > 140 ? plainText.substring(0, 140) + "..." : plainText;

            card.innerHTML = `
                <div class="job-title">${job.title}</div>
                <div class="job-company">${job.company}</div>
                
                <div class="job-details">
                    <span class="tag">üìç ${job.city} - ${job.state}</span>
                    <span class="tag">üè¢ ${job.type}</span>
                </div>

                <div class="job-description" title="${shortDesc}">
                    ${shortDesc}
                </div>

                <div class="job-footer">
                    <div class="salary">${job.salary}</div>
                    <a href="${job.applyUrl}" target="_blank" class="btn-apply">Candidatar-se ‚ûî</a>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // Filtros
    function populateFilters() {
        const states = [...new Set(allJobs.map(j => j.state).filter(Boolean))].sort();
        const cities = [...new Set(allJobs.map(j => j.city).filter(Boolean))].sort();

        const stateSelect = document.getElementById('stateFilter');
        const citySelect = document.getElementById('cityFilter');

        // Resetar mantendo a primeira op√ß√£o
        stateSelect.innerHTML = '<option value="">Todos os Estados</option>';
        citySelect.innerHTML = '<option value="">Todas as Cidades</option>';

        states.forEach(st => {
            const opt = document.createElement('option');
            opt.value = st;
            opt.innerText = st;
            stateSelect.appendChild(opt);
        });

        cities.forEach(ct => {
            const opt = document.createElement('option');
            opt.value = ct;
            opt.innerText = ct;
            citySelect.appendChild(opt);
        });
    }

    function filterData() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const state = document.getElementById('stateFilter').value;
        const city = document.getElementById('cityFilter').value;

        const filtered = allJobs.filter(job => {
            const matchText = job.title.toLowerCase().includes(term) || 
                              job.description.toLowerCase().includes(term) ||
                              job.company.toLowerCase().includes(term);
            const matchState = state ? job.state === state : true;
            const matchCity = city ? job.city === city : true;

            return matchText && matchState && matchCity;
        });

        renderJobs(filtered);
    }

    document.getElementById('searchInput').addEventListener('input', filterData);
    document.getElementById('stateFilter').addEventListener('change', filterData);
    document.getElementById('cityFilter').addEventListener('change', filterData);

    function showLoading(show, text = "Carregando...") {
        const el = document.getElementById('loading');
        el.innerText = text;
        if(show) {
            el.classList.remove('hidden');
            document.getElementById('jobsContainer').innerHTML = '';
        } else {
            el.classList.add('hidden');
        }
    }
</script>

</body>
</html>